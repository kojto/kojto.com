<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <template id="report_kojto_optimizer_2d">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="doc">
                    <div class="page">
                        <t t-set="company_contact" t-value="env['kojto.contacts'].search([('res_company_id', '=', env.company.id)], limit=1)" />
                        <t t-if="company_contact and company_contact.company_logo">
                            <t t-set="company_logo" t-value="'data:image/svg;base64,' + company_contact.company_logo.decode('utf-8')" />
                            <style> @page { @top-right { content: url("<t t-esc='company_logo' />"); width: 80px; vertical-align: bottom; padding-top: 20px; height: 100%; } } </style>
                        </t>

                        <!-- Container 0 -->
                        <div style="font-weight: bold; margin-bottom: 25px; font-size: 16px;">2D OPTIMIZATION PACKAGE</div>

                        <!-- Container 1 -->
                        <div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <table style="width: 50%; font-size: 10px; line-height: 1.2;">
                                    <tr><th style="text-align: left;">Package Name</th><td style="text-align: right;" t-esc="doc.name if doc.name else ''" /></tr>
                                    <tr><th style="text-align: left;">Subcode</th><td style="text-align: right;" t-esc="doc.subcode_id.display_name if doc.subcode_id else ''" /></tr>
                                    <tr><th style="text-align: left;">Issue Date</th><td style="text-align: right;" t-esc="doc.date_issue if doc.date_issue else ''" /></tr>
                                    <tr><th style="text-align: left;">Issued By</th><td style="text-align: right;" t-esc="doc.issued_by.display_name if doc.issued_by else ''" /></tr>
                                    <tr><th style="text-align: left;">Description</th><td style="text-align: right;" t-esc="doc.description if doc.description else ''" /></tr>
                                    <tr><th style="text-align: left;">Optimization Method</th><td style="text-align: right;" t-esc="doc.optimization_method if doc.optimization_method else ''" /></tr>
                                    <tr><th style="text-align: left;">Width of Cut (mm)</th><td style="text-align: right;" t-esc="'%.2f' % doc.width_of_cut if doc.width_of_cut or doc.width_of_cut == 0 else ''" /></tr>
                                    <tr t-if="doc.thickness"><th style="text-align: left;">Thickness (mm)</th><td style="text-align: right;" t-esc="'%.2f' % doc.thickness" /></tr>
                                    <tr t-if="doc.material_id"><th style="text-align: left;">Material</th><td style="text-align: right;" t-esc="doc.material_id.name if doc.material_id else ''" /></tr>
                                </table>
                            </div>
                        </div>

                        <!-- Container 2 (Stock Rectangles) -->
                        <div style="margin-bottom: 10px;">
                            <div style="font-weight: bold; margin-bottom: 10px; margin-top: 25px;">AVAILABLE STOCK:</div>
                            <div style="margin: 0; padding: 0;">
                                <t t-if="doc.stock_rectangles_ids">
                                    <t t-foreach="doc.stock_rectangles_ids" t-as="stock">
                                        <div style="margin-bottom: 5px;">
                                            <t t-esc="'Pos. %s - %s - %.2f x %.2f mm - Available: %s' % (stock.stock_position or 'N/A', stock.stock_description or 'N/A', stock.stock_width or 0, stock.stock_length or 0, stock.available_stock_rectangle_pieces or 0)"/>
                                        </div>
                                    </t>
                                </t>
                                <t t-if="not doc.stock_rectangles_ids">
                                    <div style="margin-bottom: 5px;">No stock rectangles defined.</div>
                                </t>
                            </div>
                        </div>

                        <!-- Container 3 (Shapes to Cut) -->
                        <div style="margin-bottom: 10px;">
                            <div style="font-weight: bold; margin-bottom: 10px; margin-top: 25px;">SHAPES TO CUT:</div>
                            <div style="margin: 0; padding: 0;">
                                <t t-if="doc.shapes_to_cut_ids">
                                    <t t-foreach="doc.shapes_to_cut_ids" t-as="shape">
                                        <div style="margin-bottom: 5px;">
                                            <t t-esc="'Pos. %s - %s - Pieces: %s - Area: %.2f mmÂ² - Weight: %.2f kg' % (shape.cut_position or 'N/A', shape.cut_description or 'N/A', shape.required_cut_shape_pieces or 0, shape.shape_area or 0, shape.shape_weight or 0)"/>
                                        </div>
                                    </t>
                                </t>
                                <t t-if="not doc.shapes_to_cut_ids">
                                    <div style="margin-bottom: 5px;">No shapes to cut defined.</div>
                                </t>
                            </div>
                        </div>

                        <!-- Container 4 (Cutting Plan) -->
                        <div style="margin-bottom: 10px;">
                            <div style="font-weight: bold; margin-bottom: 10px; margin-top: 25px;">CUTTING PLAN:</div>
                            <t t-if="doc.cutting_plan_svgs">
                                <t t-set="svg_list" t-value="doc.cutting_plan_svgs.split('\n')" />
                                <t t-foreach="svg_list" t-as="svg_data">
                                    <div style="margin: 0; padding: 0; display: inline-block;">
                                        <t t-raw="svg_data" />
                                    </div>
                                </t>
                                <!-- Minimal end marker to anchor layout -->
                                <div style="height: 1px; margin: 0; padding: 0; clear: both;"></div>
                            </t>
                            <t t-else="">
                                <div style="margin: 0; padding: 0; white-space: pre-wrap; font-family: monospace; font-size: 9px;">
                                    <t t-esc="doc.cutting_plan if doc.cutting_plan else 'No cutting plan computed yet.'"/>
                                </div>
                            </t>
                        </div>
                    </div>
                </t>
            </t>
        </template>
        <template id="print_kojto_optimizer_2d_packages">
            <t t-call="kojto_optimizer.report_kojto_optimizer_2d"/>
        </template>
    </data>
</odoo>
