<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <template id="report_kojto_contract">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="doc">
                    <div class="page">
                        <t t-set="company_contact" t-value="env['kojto.contacts'].search([('res_company_id', '=', env.company.id)], limit=1)" />
                        <!-- Debug info: Contact found: <t t-esc="company_contact.name if company_contact else 'No contact found'" /> -->
                        <!-- Debug info: Logo exists: <t t-esc="'Yes' if company_contact and company_contact.company_logo else 'No'" /> -->
                        <t t-if="company_contact and company_contact.company_logo">
                            <t t-set="company_logo" t-value="'data:image/svg;base64,' + company_contact.company_logo.decode('utf-8')" />
                            <style> @page { @top-right { content: url("<t t-esc='company_logo' />"); width: 80px; vertical-align: bottom; padding-top: 20px; height: 100%; } } </style>
                        </t>
                        <div t-attf-style="string-set: date_start '{{ doc.date_start.strftime('%Y-%m-%d') if doc.date_start else '' }}';">
                            <div class="info-section">
                                <div>
                                    <table>
                                        <tr t-if="doc.contract_type == 'contract'">
                                            <td class="label"><h1>CONTRACT </h1></td>
                                            <td class="content"><h1><span t-field="doc.name" /></h1></td>
                                        </tr>
                                        <tr t-if="doc.contract_type == 'annex'">
                                            <td class="label"><h1>ANNEX </h1></td>
                                            <td class="content"><h1><span t-field="doc.name" /></h1></td>
                                        </tr>
                                        <tr t-if="doc.contract_type == 'order'">
                                            <td class="label"><h1>ORDER </h1></td>
                                            <td class="content"><h1><span t-field="doc.name" /></h1></td>
                                        </tr>
                                        <tr t-if="doc.contract_type == 'order_confirmation'">
                                            <td class="label"><h1>ORDER CONFIRMATION </h1></td>
                                            <td class="content"><h1><span t-field="doc.name" /></h1></td>
                                        </tr>
                                        <tr t-if="doc.contract_type != 'contract' and doc.contract_type != 'annex' and doc.contract_type != 'order' and doc.contract_type != 'order_confirmation'">
                                            <td class="label"><h1><t t-esc="dict(doc._fields['contract_type']._description_selection(doc.env)).get(doc.contract_type, doc.contract_type).upper()" /> </h1></td>
                                            <td class="content"><h1><span t-field="doc.name" /></h1></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="info-section">
                            <div class="info-cell" t-if="doc.document_in_out_type == 'outgoing'">
                                <table class="info-table">
                                    <tr>
                                        <td class="label">Client:</td>
                                        <td class="content"><span t-field="doc.company_name_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Address:</td>
                                        <td class="content"><span t-field="doc.company_address_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Tax ID:</td>
                                        <td class="content" t-esc="doc.company_tax_number_id.name" />
                                    </tr>
                                    <tr>
                                        <td class="label">Reg. #:</td>
                                        <td class="content" t-esc="doc.company_registration_number" />
                                    </tr>
                                    <tr>
                                        <td class="label">IBAN:</td>
                                        <td class="content">
                                            <span t-esc="doc.company_bank_account_id.IBAN or ''" />
                                            <span t-if="doc.company_bank_account_id and doc.company_bank_account_id.currency_id" t-esc="'(' + doc.company_bank_account_id.currency_id.name + ')'" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="label">BIC:</td>
                                        <td class="content" t-esc="doc.company_bank_account_id.BIC or ''" />
                                    </tr>
                                    <tr>
                                        <td class="label">Email:</td>
                                        <td class="content"><span t-field="doc.company_email_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Phone:</td>
                                        <td class="content"><span t-field="doc.company_phone_id" /></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="info-cell" t-if="doc.document_in_out_type == 'outgoing'">
                                <table class="info-table">
                                    <tr>
                                        <td class="label">Contractor:</td>
                                        <td class="content"><span t-field="doc.counterparty_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Address:</td>
                                        <td class="content"><span t-field="doc.counterparty_address_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Tax ID:</td>
                                        <td class="content" t-esc="doc.counterparty_tax_number_id.name" />
                                    </tr>
                                    <tr>
                                        <td class="label">Reg. #:</td>
                                        <td class="content" t-esc="doc.counterparty_registration_number" />
                                    </tr>
                                    <tr>
                                        <td class="label">IBAN:</td>
                                        <td class="content">
                                            <span t-esc="doc.counterparty_bank_account_id.IBAN or ''" />
                                            <span t-if="doc.counterparty_bank_account_id and doc.counterparty_bank_account_id.currency_id" t-esc="'(' + doc.counterparty_bank_account_id.currency_id.name + ')'" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="label">BIC:</td>
                                        <td class="content" t-esc="doc.counterparty_bank_account_id.BIC or ''" />
                                    </tr>
                                    <tr>
                                        <td class="label">Email:</td>
                                        <td class="content"><span t-field="doc.counterparty_email_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Phone:</td>
                                        <td class="content"><span t-field="doc.counterparty_phone_id" /></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="info-cell" t-if="doc.document_in_out_type == 'incoming'">
                                <table class="info-table">
                                    <tr>
                                        <td class="label">Client:</td>
                                        <td class="content"><span t-field="doc.counterparty_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Address:</td>
                                        <td class="content"><span t-field="doc.counterparty_address_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Tax ID:</td>
                                        <td class="content" t-esc="doc.counterparty_tax_number_id.name" />
                                    </tr>
                                    <tr>
                                        <td class="label">Reg. #:</td>
                                        <td class="content" t-esc="doc.counterparty_registration_number" />
                                    </tr>
                                    <tr>
                                        <td class="label">IBAN:</td>
                                        <td class="content">
                                            <span t-esc="doc.counterparty_bank_account_id.IBAN or ''" />
                                            <span t-if="doc.counterparty_bank_account_id and doc.counterparty_bank_account_id.currency_id" t-esc="'(' + doc.counterparty_bank_account_id.currency_id.name + ')'" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="label">BIC:</td>
                                        <td class="content" t-esc="doc.counterparty_bank_account_id.BIC or ''" />
                                    </tr>
                                    <tr>
                                        <td class="label">Email:</td>
                                        <td class="content"><span t-field="doc.counterparty_email_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Phone:</td>
                                        <td class="content"><span t-field="doc.counterparty_phone_id" /></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="info-cell" t-if="doc.document_in_out_type == 'incoming'">
                                <table class="info-table">
                                    <tr>
                                        <td class="label">Contractor:</td>
                                        <td class="content"><span t-field="doc.company_name_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Address:</td>
                                        <td class="content"><span t-field="doc.company_address_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Tax ID:</td>
                                        <td class="content" t-esc="doc.company_tax_number_id.name" />
                                    </tr>
                                    <tr>
                                        <td class="label">Reg. #:</td>
                                        <td class="content" t-esc="doc.company_registration_number" />
                                    </tr>
                                    <tr>
                                        <td class="label">IBAN:</td>
                                        <td class="content">
                                            <span t-esc="doc.company_bank_account_id.IBAN or ''" />
                                            <span t-if="doc.company_bank_account_id and doc.company_bank_account_id.currency_id" t-esc="'(' + doc.company_bank_account_id.currency_id.name + ')'" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="label">BIC:</td>
                                        <td class="content" t-esc="doc.company_bank_account_id.BIC or ''" />
                                    </tr>
                                    <tr>
                                        <td class="label">Email:</td>
                                        <td class="content"><span t-field="doc.company_email_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Phone:</td>
                                        <td class="content"><span t-field="doc.company_phone_id" /></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="body">
                            <table class="references-table">
                                <tr>
                                    <td class="label">Our Reference:</td>
                                    <td class="content" t-esc="doc.name" />
                                    <td class="label">Your Reference:</td>
                                    <td class="content" t-esc="doc.counterpartys_reference" />
                                </tr>
                                <tr>
                                    <td class="label">Start Date:</td>
                                    <td class="content" t-esc="doc.date_start.strftime('%d.%m.%Y') if doc.date_start else ''" />
                                    <td class="label">End Date:</td>
                                    <td class="content" t-esc="doc.date_end.strftime('%d.%m.%Y')" t-if="doc.date_end" />
                                </tr>
                                <tr>
                                    <td class="label">Payment Terms:</td>
                                    <td class="content" t-esc="doc.payment_terms_id.name" />
                                    <td class="label">Language:</td>
                                    <td class="content" t-esc="doc.language_id.name" />
                                </tr>
                                <tr>
                                    <td class="label">Incoterms:</td>
                                    <td class="content" colspan="3" t-esc="doc.incoterms_id.name" />
                                </tr>
                                <tr>
                                    <td class="label">Incoterms Address:</td>
                                    <td class="content" colspan="3" t-esc="doc.incoterms_address" />
                                </tr>
                            </table>

                            <p>
                                <strong>Subject:</strong>
                                <t t-esc="doc.subject" />
                            </p>

                            <div t-esc="doc.pre_content_text" style="white-space: pre-wrap;" />
                            <table class="content-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Description</th>
                                        <th style="text-align: right" class="ko-w-70">Quantity</th>
                                        <th style="text-align: right" class="ko-w-70">Unit Price</th>
                                        <th style="text-align: right" class="ko-w-70">Pre VAT Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="doc.content.sorted(lambda x: x.position or 0)" t-as="line">
                                        <tr>
                                            <td t-esc="line.position if line.position else ''" />
                                            <td t-esc="line.name if line.name else ''" />
                                            <td style="text-align: right">
                                                <t t-if="line.unit_id">
                                                    <t t-set="translated_unit_name"
                                                        t-value="line.unit_id.translation_ids.filtered(lambda t: t.language_id.code == env.context.get('lang', 'en_US')).name or line.unit_id.name" />
                                                    <t t-esc="'%.2f %s' % (line.quantity, translated_unit_name) if line.quantity or line.quantity == 0 else ''" />
                                                </t>
                                                <t t-else="">
                                                    <t t-esc="'%.2f' % line.quantity if line.quantity or line.quantity == 0 else ''" />
                                                </t>
                                            </td>
                                            <td style="text-align: right" t-esc="'%.2f %s' % (line.unit_price, doc.currency_id.name) if line.unit_price or line.unit_price == 0 else ''" />
                                            <td style="text-align: right" t-esc="'%.2f %s' % (line.pre_vat_total, doc.currency_id.name) if line.pre_vat_total or line.pre_vat_total == 0 else ''" />
                                        </tr>
                                    </t>
                                </tbody>
                            </table>


                            <div style="page-break-inside: avoid; display: inline-block; width: 100%;">
                                <table class="totals-table">
                                    <tr>
                                        <td>Net Sum:</td>
                                        <td t-esc="'%.2f %s' % (doc.pre_vat_total, doc.currency_id.name)" />
                                    </tr>
                                    <tr>
                                        <td>Total VAT:</td>
                                        <td t-esc="'%.2f %s' % (doc.vat_total, doc.currency_id.name)" />
                                    </tr>
                                    <tr>
                                        <td>Total Amount:</td>
                                        <td t-esc="'%.2f %s' % (doc.total_price, doc.currency_id.name)" />
                                    </tr>
                                </table>
                            </div>

                            <div t-esc="doc.post_content_text" style="white-space: pre-wrap;" />

                            <div t-if="doc.parent_contract_id">
                                <strong>Parent Contract:</strong>
                                <span t-esc="doc.parent_contract_id.name" />
                            </div>
                            <div t-if="doc.program">
                                <strong>Program:</strong>
                                <p t-esc="doc.program" />
                            </div>
                        </div>
                        <!-- VAT Rate Summary -->
                        <div class="vat-rate-summary">
                            <strong>VAT Rate Summary:</strong>
                            <t t-set="vat_rate_groups" t-value="{}" />
                            <t t-foreach="doc.content.sorted(lambda x: x.position or 0)" t-as="line">
                                <t t-if="line.vat_rate or line.vat_rate == 0">
                                    <t t-set="vat_rate_key" t-value="'%.2f' % line.vat_rate" />
                                    <t t-set="vat_rate_groups"
                                        t-value="dict(vat_rate_groups, **{vat_rate_key: vat_rate_groups.get(vat_rate_key, []) + [line.position or '']})" />
                                </t>
                            </t>
                            <t t-foreach="vat_rate_groups" t-as="vat_rate_group">
                                <p t-esc="'{}% (position {})'.format(vat_rate_group, ', '.join([pos for pos in vat_rate_groups[vat_rate_group] if pos]))" />
                            </t>
                        </div>
                        <div class="footer-section">
                            <p>---- END OF CONTRACT ----</p>
                        </div>
                    </div>
                </t>
            </t>
        </template>
    </data>
</odoo>
